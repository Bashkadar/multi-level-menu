<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Multi-level menu</title>
    <style>
        body{
            font-family: 'Roboto', sans-serif;
            background-color: #f8f8f8;
        }
        .container{
            margin-left: 50%;
            margin-top: 20%;
        }

        .typelang{
            font-size:16px;
            color: #66e1ff;
            border: #66e1ff solid 1px;
            padding: 7px;
            border-radius:3px;
        }
        .typelang a{
            color: #66e1ff;
            font-style: normal;
            text-decoration: none;
        }

        .menu {
            font-family: 'Roboto',Arial, Helvetica, sans-serif;
            position:absolute;
            border:1px solid #adadad;
            background-color: #ffffff;
            border-radius:3px;
            color: #000000;
            z-index: 50;
            box-shadow: 0 1px 10px rgba(0, 0, 0, 0.6);
            opacity: 0;
            /*display:none;*/
            visibility: hidden;
            transition: visibility 400ms, opacity 400ms;
        }
        .menu_pt{
            padding-top: 5px;
            padding-bottom: 5px;
        }
        .menu_pt tr td {
            padding: 8px;
        }
        .punkt:hover {
            color: #76ebff;
            cursor:pointer;
        }
        .triangle{
            margin-left: 5px;
            margin-top: 3px;
            float: right;
            width:0;
            height:0;
            border-top: 6px solid transparent;
            border-left: 8px solid #76ebff;
            border-bottom: 6px solid transparent;
        }
    </style>
</head>
<body>

<div class="container">
    <span class="typelang"><a href="/profile">Меню</a></span>
</div>

<script>

    let list = {
        1:{"name":"пункт 1", "sub":{
            1:{"name":"пункт 1.1"},
            2:{"name":"пункт 1.2"},
            3:{"name":"пункт 1.3", "sub":{
                1:{"name":"пункт 1.3.1"},
                2:{"name":"пункт 1.3.2"}
            }},
            4:{"name":"пункт 1.4"},
            5:{"name":"пункт 1.5", "sub":{
                1:{"name":"пункт 1.5.1"},
                2:{"name":"пункт 1.5.2"}
            }}
        }},
        2:{"name":"пункт 2", "sub":{
            1:{"name":"пункт 2.1"},
            2:{"name":"пункт 2.2"}
        }},
        3:{"name":"пункт 3",
            "sub":{
                1:{"name":"пункт 3.1"},
                2:{"name":"пункт 3.2",
                    "sub":{
                        1:{"name":"пункт 3.2.1", "sub":{
                            1:{"name":"пункт 3.2.1.1"},
                            2:{"name":"пункт 3.2.1.2"},
                            3:{"name":"пункт 3.2.1.3"},
                            4:{"name":"пункт 3.2.1.4"},
                            5:{"name":"пункт 3.2.1.5"}
                        }
                        },
                        2:{"name":"пункт 3.2.2"},
                        3:{"name":"пункт 3.2.3"}
                    }
                },
                3:{"name":"пункт 3.3"},
                4:{"name":"пункт 3.3"}
            }
        },
        4:{"name":"пункт 4"}
    }

    let menu = document.getElementsByClassName('typelang')[0],
            over = false,
            time = [],
            menu_dict = {},
            open_dict = {};

    function addEventHandler(n, t, f){
        if (n.addEventListener){
            n.addEventListener(t, f, false);
        } else if(n.attachEvent){
            n.attachEvent('on' + t, f);
        } else {
            n['on' + t] = f;
        }
    }

    class Sequence {

        constructor() {
            this.a = 1;
            this.b = 0;
        }

        incr(){
            return this.a++;
        }

    }

    let seq = new Sequence();

    class MenuList {

        constructor(j) {
            let arr = [];
            let el = document.createElement("div");
            el.className = 'menu';
            let tb = document.createElement("table");
            tb.className = 'menu_pt';

            for(let k in j){
                if(j.hasOwnProperty(k)){
                    let tr = document.createElement("tr");
                    let td = document.createElement("td");
                    let sp = document.createElement("span");
                    sp.className = 'punkt';
                    if(j[k]["sub"]){
                        sp.id = seq.incr();
                        let di = document.createElement("div");
                        di.className = 'triangle';
                        td.append(di);
                        let sub = new MenuList(j[k]["sub"]);
                        menu_dict[sp.id] = sub.create_menu();
                        arr.push(sp.id);
                    }

                    sp.innerHTML = j[k]["name"];
                    td.append(sp);
                    tr.append(td);
                    tb.append(tr);
                }
            }

            el.append(tb);

            this.a = el;

            if(arr.length>1){
                arr.forEach(function(el){
                    let ar = [];
                    for (let i=0;arr.length>i;i++){
                        if(arr[i]!=el){ar.push(arr[i])}
                    }
                    open_dict[el] = ar;
                });
            }
        }

        create_menu(){
            return this.a;
        }
    }

    let menu_inst = new MenuList(list);
    menu_dict[0] = menu_inst.create_menu();

    for (let i in menu_dict){
        if(menu_dict.hasOwnProperty(i)){
            menu.append(menu_dict[i]);
            let menu_link = document.getElementById(i.toString());
            if(i>0){
                addEventHandler(menu_link, 'mouseover', function(){
                    if (time[i]) {
                        clearTimeout(time[i]);
                    }
                    if(open_dict[i]){
                        open_dict[i].forEach(function(el){
                            for(let ii=el;time.length>ii;ii++){
                                if(i!=ii){
                                    menuFade(menu_dict[ii],0);
                                }
                            }
                        });
                    }
                    menuShow(menu_dict[i], menu_link.previousElementSibling.getBoundingClientRect(), 400, -20, -15);
                });
                addEventHandler(menu_link, 'mouseout', function(){
                    time[i] = setTimeout(function(){
                        menuFade(menu_dict[i], 150);
                    }, 400);
                });
                addEventHandler(menu_dict[i], 'mouseover', function(){
                    for(let o=0;o<=i;o++){
                        if (time[o]) {
                            clearTimeout(time[o]);
                        }
                    }
                });
                addEventHandler(menu_dict[i], 'mouseout', function(){
                    time[i] = setTimeout(function(){
                        menuFade(menu_dict[i],150);
                    },400);
                });
            }
        }
    }

    function menuShow(m, c, ms, top, left){
        over = true;
        if(m.style.opacity !== '1'){
            m.style.top = c.top + pageYOffset + top + 'px';
            m.style.left = c.left + pageXOffset - left + 'px';
            m.style.transition = 'visibility '+ms+'ms, opacity '+ms+'ms';
            m.style.visibility = 'visible';
            m.style.opacity = '1';
        }
    }

    function menuFade(m, ms){
        m.style.visibility = 'hidden';
        m.style.transition = 'visibility '+ms+'ms, opacity '+ms+'ms';
        m.style.opacity = '0';
    }

    function overMenu() {
        if (time[0]) {
            clearTimeout(time[0]);
        }
        menuShow(menu_dict[0], menu.getBoundingClientRect(), 400, 25, 5);
    }

    function closeAllOut() {
        over = false;
        time[0] = setTimeout(function(){
            for(let k in menu_dict){
                if(menu_dict.hasOwnProperty(k)){
                    menuFade(menu_dict[k],150);
                }
            }
        },400);
    }

    function closeAllClick(){
        if(!over){
            for(let k in menu_dict){
                if(menu_dict.hasOwnProperty(k)){
                    menuFade(menu_dict[k],80);
                }
            }
        }
    }

    addEventHandler(menu, 'mouseover', overMenu);
    addEventHandler(menu, 'mouseout', closeAllOut);
    addEventHandler(document, 'mousedown', closeAllClick);

</script>
</body>
</html>
